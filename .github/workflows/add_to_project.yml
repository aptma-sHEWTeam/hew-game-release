name: Auto Add Issue to Project

on:
  issues:
    types: [opened, edited]

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (for shared scripts)
        uses: actions/checkout@v4

      - name: Add to Project (best-effort)
        uses: actions/add-to-project@v0.5.0
        id: add-project
        with:
          project-url: https://github.com/orgs/aptma-sHEWTeam/projects/3
          github-token: ${{ secrets.ORG_PROJECTS_TOKEN }}

      - name: Debug - Show add-project outputs
        run: |
          echo "Item ID: ${{ steps.add-project.outputs.itemId }}"
          echo "All outputs: ${{ toJson(steps.add-project.outputs) }}"

      - name: Extract Issue Fields (robust)
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const raw = context.payload.issue.body || '';
            const lines = raw.replace(/\r\n/g, '\n').split('\n');
            console.log('=== Issue Body (normalized) ===');
            console.log(lines.join('\n'));
            console.log('=== /Issue Body ===');

            // ラベルの別名（小文字で比較）
            const aliases = {
              role: ['role'],
              team: ['programteam','team'],
              priority: ['priority'],
              component: ['component','component (任意)'],
              size: ['size'],
              estimate: ['estimate','estimate (時間)'],
              start_date: ['start date','start date (yyyy-mm-dd)'],
              due_date: ['end date','due date','end date (yyyy-mm-dd)']
            };

            function norm(s){ return (s||'').trim().toLowerCase().replace(/^#+\s*/, ''); }

            function pick(keys){
              for (let i=0;i<lines.length;i++){
                const l = norm(lines[i]);
                for (const k of keys){
                  if (l.startsWith(k)){
                    // 同一行に ":" があればその後を値とする。なければ次の非空行を使う
                    const after = lines[i].split(/[:：]/).slice(1).join(':').trim();
                    if (after) return after;
                    let j=i+1; while(j<lines.length && lines[j].trim().length===0) j++;
                    if (j<lines.length) return lines[j].trim();
                    return '';
                  }
                }
              }
              return '';
            }

            const out = {
              role: pick(aliases.role),
              team: pick(aliases.team),
              priority: pick(aliases.priority),
              component: pick(aliases.component),
              size: pick(aliases.size),
              estimate: pick(aliases.estimate),
              start_date: pick(aliases.start_date),
              due_date: pick(aliases.due_date)
            };

            console.log('Extracted:', out);
            for (const [k,v] of Object.entries(out)) core.setOutput(k, v);

      - name: Debug - Show extracted fields
        run: |
          echo "Role: ${{ steps.extract.outputs.role }}"
          echo "Team: ${{ steps.extract.outputs.team }}"
          echo "Priority: ${{ steps.extract.outputs.priority }}"
          echo "Component: ${{ steps.extract.outputs.component }}"
          echo "Size: ${{ steps.extract.outputs.size }}"
          echo "Estimate: ${{ steps.extract.outputs.estimate }}"
          echo "Start Date: ${{ steps.extract.outputs.start_date }}"
          echo "Due Date: ${{ steps.extract.outputs.due_date }}"

      - name: Get Project Data (use existing item or add)
        uses: actions/github-script@v7
        id: project-data
        env:
          ITEM_ID_HINT: ${{ steps.add-project.outputs.itemId }}
        with:
          github-token: ${{ secrets.ORG_PROJECTS_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const org = 'aptma-sHEWTeam';
            const projectNumber = 3;
            const itemIdHint = process.env.ITEM_ID_HINT;

            const projQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2Field { id name dataType }
                        ... on ProjectV2SingleSelectField { id name dataType options { id name } }
                      }
                    }
                  }
                }
              }
            `;

            const addMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) { item { id } }
              }
            `;

            // 1) プロジェクトIDとフィールドだけ取得
            const res = await github.graphql(projQuery, { org, number: projectNumber });
            const project = res.organization.projectV2;
            const projectId = project.id;

            // 2) アイテムIDを決定
            let itemId = itemIdHint;
            if (!itemId) {
              try {
                const addRes = await github.graphql(addMutation, { projectId, contentId: issue.node_id });
                itemId = addRes.addProjectV2ItemById.item.id;
                console.log('Added item via mutation:', itemId);
              } catch (e) {
                console.log('Add mutation failed (may already exist):', e.message);
              }
            }
            if (!itemId) {
              throw new Error('itemId could not be determined');
            }

            core.setOutput('item_id', itemId);
            core.setOutput('project_id', projectId);

            const fields = {}; const fieldOptions = {};
            for (const f of project.fields.nodes) {
              fields[f.name] = f.id;
              if (f.options) {
                const map = {}; for (const o of f.options) map[o.name] = o.id; fieldOptions[f.name] = map;
              }
            }
            core.setOutput('fields', JSON.stringify(fields));
            core.setOutput('field_options', JSON.stringify(fieldOptions));

      - name: Set Project Fields
        uses: actions/github-script@v7
        if: always()
        env:
          PROJECT_ID: ${{ steps.project-data.outputs.project_id }}
          ITEM_ID: ${{ steps.project-data.outputs.item_id }}
          FIELDS: ${{ steps.project-data.outputs.fields }}
          FIELD_OPTIONS: ${{ steps.project-data.outputs.field_options }}
          ROLE: ${{ steps.extract.outputs.role }}
          TEAM: ${{ steps.extract.outputs.team }}
          PRIORITY: ${{ steps.extract.outputs.priority }}
          COMPONENT: ${{ steps.extract.outputs.component }}
          SIZE: ${{ steps.extract.outputs.size }}
          ESTIMATE: ${{ steps.extract.outputs.estimate }}
          START_DATE: ${{ steps.extract.outputs.start_date }}
          DUE_DATE: ${{ steps.extract.outputs.due_date }}
        with:
          github-token: ${{ secrets.ORG_PROJECTS_TOKEN }}
          script: |
            const path = require('path');
            const fs = require('fs');
            const scriptPath = path.join(process.env.GITHUB_WORKSPACE, '.github/workflows/scripts/set-project-fields.js');
            console.log('Using script:', scriptPath);
            if (!fs.existsSync(scriptPath)) {
              core.setFailed(`[Missing] set-project-fields.js が見つかりません。path=${scriptPath}`);
              return;
            }
            const run = require(scriptPath);
            await run({ core, github, process });
